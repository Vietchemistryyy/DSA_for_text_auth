<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Digital Signature System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Collapsible guide section */
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .guide-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .guide-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .guide-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .guide-content.collapsed {
            max-height: 0;
        }

        /* Two column layout for form inputs */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-grid .form-group {
            margin-bottom: 0;
        }

        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .header {
            background: #2196f3;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header h3 {
            color: white;
            font-size: 1.1em;
            font-weight: 400;
            margin: 0;
        }

        .footer {
            background: #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin-top: 40px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .footer p {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 400;
        }

        .footer strong {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .key-status {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .key-status h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
        }

        .key-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .key-item {
            padding: 18px;
            border-radius: 10px;
            background: #f8f9fa;
            font-size: 16px;
        }

        .key-item strong {
            font-size: 17px;
        }

        .key-item>div {
            font-size: 14px !important;
        }

        .key-item.has-key {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .key-item.no-key {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .key-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .key-actions .btn {
            flex: 1 1 auto;
            min-width: 180px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 16px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .tab-content h2 {
            font-size: 26px;
            margin-bottom: 25px;
            color: #667eea;
            font-weight: 600;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-control.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-block {
            width: 100%;
        }

        .alert {
            padding: 16px 22px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 16px;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .result-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 16px;
            word-break: break-all;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .result-box h4 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 20px;
            font-weight: 600;
        }

        .result-box p {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 12px 30px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .file-name {
            margin-left: 15px;
            color: #666;
            font-style: italic;
            font-size: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }



        /* Responsive styles */
        @media (max-width: 1024px) {
            .tab-content>div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            .result-box>div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 768px) {
            .key-info {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .key-actions {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2em;
            }

            .header h3 {
                font-size: 1em;
            }

            .footer p {
                font-size: 14px;
            }

            .footer strong {
                font-size: 16px;
            }

            .tab-content {
                padding: 20px;
            }

            .result-box {
                padding: 15px;
            }

            .result-box code {
                font-size: 11px !important;
            }
        }

        /* Ensure no overflow */
        .form-control,
        .result-box,
        .result-box code,
        .result-box pre {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-all;
        }

        .result-box {
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>DSA Digital Signature System</h1>
            <h3>H·ªá th·ªëng Ch·ªØ k√Ω s·ªë an to√†n v·ªõi thu·∫≠t to√°n DSA</h3>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('demo-algorithm')">
                Demo thu·∫≠t to√°n DSA
            </button>
            <button class="tab-button" onclick="switchTab('sign-file')">
                Ch·ªØ k√Ω s·ªë DSA v·ªõi kh√≥a t·ª± ƒë·ªông
            </button>
        </div>

        <!-- Tab: Demo Algorithm -->
        <div class="tab-content active" id="demo-algorithm">
            <h2>Demo Thu·∫≠t to√°n DSA</h2>

            <div
                style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div class="guide-header" onclick="toggleGuide('demoGuide', 'demoGuideIcon')">
                    <h4 style="color: #1976d2; margin: 0; font-size: 20px; font-weight: 600;">üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Demo
                        Thu·∫≠t to√°n</h4>
                    <button class="guide-toggle" id="demoGuideIcon">‚ñº</button>
                </div>
                <div class="guide-content collapsed" id="demoGuide"
                    style="color: #0d47a1; line-height: 1.8; font-size: 17px; margin-top: 12px;">
                    <p style="margin: 0 0 10px 0;"><strong>M·ª•c ƒë√≠ch:</strong> Demo chi ti·∫øt t·ª´ng b∆∞·ªõc t√≠nh to√°n c·ªßa
                        thu·∫≠t to√°n DSA v·ªõi tham s·ªë t√πy ch·ªânh.</p>
                    <ol style="margin: 0 0 10px 0; padding-left: 25px;">
                        <li style="margin-bottom: 6px;"><strong>B∆∞·ªõc 1:</strong> Nh·∫•n "T·∫£i tham s·ªë ƒë∆°n gi·∫£n" ƒë·ªÉ t·ª± ƒë·ªông
                            ƒëi·ªÅn c√°c tham s·ªë DSA h·ª£p l·ªá.</li>
                        <li style="margin-bottom: 6px;"><strong>B∆∞·ªõc 2:</strong> Ch·ªçn lo·∫°i n·ªôi dung (VƒÉn b·∫£n/File), nh·∫≠p
                            n·ªôi dung c·∫ßn k√Ω, nh·∫•n "K√Ω".</li>
                        <li style="margin-bottom: 6px;"><strong>B∆∞·ªõc 3:</strong> Sao ch√©p c√°c gi√° tr·ªã (p, q, g, y, r, s)
                            sang ph·∫ßn X√°c th·ª±c b√™n ph·∫£i v√† nh·∫•n "X√°c th·ª±c".</li>
                        <li><strong>B∆∞·ªõc 4:</strong> Th·ª≠ thay ƒë·ªïi c√°c gi√° tr·ªã ƒë·ªÉ ki·ªÉm tra x√°c th·ª±c th·∫•t b·∫°i.</li>
                    </ol>
                    <p
                        style="margin: 0; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 16px;">
                        üí° S·ª≠ d·ª•ng s·ªë nguy√™n nh·ªè (< 1000) ƒë·ªÉ d·ªÖ ki·ªÉm tra t√≠nh to√°n th·ªß c√¥ng.</p>
                </div>
            </div>

            <!-- B·ªê TR√ç NGANG: K√ù B√äN TR√ÅI - X√ÅC TH·ª∞C B√äN PH·∫¢I -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">

                <!-- PH·∫¶N K√ù (B√äN TR√ÅI) -->
                <div
                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 3px solid #4caf50; border-radius: 12px; padding: 20px;">
                    <h3
                        style="color: #2e7d32; margin-bottom: 20px; font-size: 20px; text-align: center; font-weight: 700;">
                        K√ù VƒÇN B·∫¢N</h3>

                    <div class="alert" id="demoSignAlert"></div>

                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label style="color: #2e7d32; font-weight: 600;">Tham s·ªë p:</label>
                            <input type="text" class="form-control" id="demoP" placeholder="VD: 23"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="demoPError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #2e7d32; font-weight: 600;">Tham s·ªë q:</label>
                            <input type="text" class="form-control" id="demoQ" placeholder="VD: 11"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="demoQError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #2e7d32; font-weight: 600;">Tham s·ªë g:</label>
                            <input type="text" class="form-control" id="demoG" placeholder="VD: 2"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="demoGError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #2e7d32; font-weight: 600;">Private key x:</label>
                            <input type="text" class="form-control" id="demoX" placeholder="VD: 6"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="demoXError"></div>
                        </div>

                        <div class="form-group full-width">
                            <label style="color: #2e7d32; font-weight: 600;">Tham s·ªë k (t√πy ch·ªçn):</label>
                            <input type="text" class="form-control" id="demoK"
                                placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ h·ªá th·ªëng t·ª± sinh ng·∫´u nhi√™n"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="demoKError"></div>
                        </div>

                        <button class="btn btn-secondary full-width" onclick="loadSimpleParams()" style="width: 100%;">
                            T·∫£i Tham s·ªë ƒê∆°n gi·∫£n
                        </button>

                        <div class="full-width" style="border-top: 2px dashed #2e7d32; margin: 5px 0;"></div>

                        <!-- Ch·ªçn gi·ªØa vƒÉn b·∫£n ho·∫∑c file -->
                        <div class="full-width" style="background: white; border-radius: 8px; padding: 10px;">
                            <label style="color: #2e7d32; font-weight: 600; margin-bottom: 6px; display: block;">Ch·ªçn
                                lo·∫°i n·ªôi dung:</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="demoSignType" value="text" checked
                                        onchange="toggleDemoSignInput()"> VƒÉn b·∫£n
                                </label>
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="demoSignType" value="file"
                                        onchange="toggleDemoSignInput()"> File
                                </label>
                            </div>
                        </div>

                        <!-- Input vƒÉn b·∫£n -->
                        <div id="demoTextInput" class="form-group full-width">
                            <label style="color: #2e7d32; font-weight: 600;">VƒÉn b·∫£n c·∫ßn k√Ω:</label>
                            <textarea class="form-control" id="demoMessage"
                                placeholder="Nh·∫≠p n·ªôi dung vƒÉn b·∫£n c·∫ßn k√Ω..." style="min-height: 80px;"></textarea>
                            <div class="error-message" id="demoMessageError"></div>
                        </div>

                        <!-- Input file -->
                        <div id="demoFileInput" class="form-group full-width" style="display: none;">
                            <label style="color: #2e7d32; font-weight: 600;">File c·∫ßn k√Ω:</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="demoFile"
                                    onclick="resetFileInput('demoFile')"
                                    onchange="updateFileName('demoFile', 'demoFileName'); previewFileContent('demoFile', 'demoFilePreview', 'demoFileContent')">
                                <label for="demoFile" class="file-input-label">
                                    Ch·ªçn File
                                </label>
                                <span class="file-name" id="demoFileName">Ch∆∞a ch·ªçn file</span>
                            </div>
                            <div id="demoFilePreview"
                                style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; display: none; max-height: 100px; overflow-y: auto;">
                                <strong style="color: #2e7d32; font-size: 13px;">N·ªôi dung:</strong>
                                <pre id="demoFileContent"
                                    style="margin: 5px 0 0 0; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Inter', sans-serif;"></pre>
                            </div>
                            <div class="error-message" id="demoFileError"></div>
                        </div>

                        <button class="btn btn-primary btn-block full-width" onclick="demoSign()">
                            K√Ω
                        </button>
                    </div>

                    <div class="loading" id="demoLoading">
                        <div class="spinner"></div>
                        <p>ƒêang t√≠nh to√°n...</p>
                    </div>

                    <div id="demoResult"></div>
                </div>

                <!-- PH·∫¶N X√ÅC TH·ª∞C (B√äN PH·∫¢I) -->
                <div
                    style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 3px solid #2196f3; border-radius: 12px; padding: 20px;">
                    <h3
                        style="color: #1565c0; margin-bottom: 20px; font-size: 20px; text-align: center; font-weight: 700;">
                        X√ÅC TH·ª∞C CH·ªÆ K√ù</h3>

                    <div class="alert" id="demoVerifyAlert"></div>

                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label style="color: #1565c0; font-weight: 600;">Tham s·ªë p:</label>
                            <input type="text" class="form-control" id="verifyP" placeholder="Sao ch√©p p t·ª´ b√™n tr√°i"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="verifyPError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #1565c0; font-weight: 600;">Tham s·ªë q:</label>
                            <input type="text" class="form-control" id="verifyQ" placeholder="Sao ch√©p q t·ª´ b√™n tr√°i"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="verifyQError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #1565c0; font-weight: 600;">Tham s·ªë g:</label>
                            <input type="text" class="form-control" id="verifyG" placeholder="Sao ch√©p g t·ª´ b√™n tr√°i"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="verifyGError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #1565c0; font-weight: 600;">Public key y:</label>
                            <input type="text" class="form-control" id="verifyY" placeholder="L·∫•y y t·ª´ k·∫øt qu·∫£ k√Ω"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="verifyYError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #1565c0; font-weight: 600;">Ch·ªØ k√Ω r:</label>
                            <input type="text" class="form-control" id="verifyR" placeholder="L·∫•y r t·ª´ k·∫øt qu·∫£ k√Ω"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="verifyRError"></div>
                        </div>

                        <div class="form-group">
                            <label style="color: #1565c0; font-weight: 600;">Ch·ªØ k√Ω s:</label>
                            <input type="text" class="form-control" id="verifyS" placeholder="L·∫•y s t·ª´ k·∫øt qu·∫£ k√Ω"
                                style="font-family: monospace; font-size: 14px;">
                            <div class="error-message" id="verifySError"></div>
                        </div>

                        <div class="full-width" style="border-top: 2px dashed #1565c0; margin: 5px 0;"></div>

                        <!-- Ch·ªçn gi·ªØa vƒÉn b·∫£n ho·∫∑c file -->
                        <div class="full-width" style="background: white; border-radius: 8px; padding: 10px;">
                            <label style="color: #1565c0; font-weight: 600; margin-bottom: 6px; display: block;">Ch·ªçn
                                lo·∫°i n·ªôi dung:</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="demoVerifyType" value="text" checked
                                        onchange="toggleDemoVerifyInput()"> VƒÉn b·∫£n
                                </label>
                                <label style="flex: 1; cursor: pointer;">
                                    <input type="radio" name="demoVerifyType" value="file"
                                        onchange="toggleDemoVerifyInput()"> File
                                </label>
                            </div>
                        </div>

                        <!-- Input vƒÉn b·∫£n -->
                        <div id="demoVerifyTextInput" class="form-group full-width">
                            <label style="color: #1565c0; font-weight: 600;">VƒÉn b·∫£n c·∫ßn x√°c th·ª±c:</label>
                            <textarea class="form-control" id="verifyMessage"
                                placeholder="Sao ch√©p n·ªôi dung vƒÉn b·∫£n t·ª´ ph·∫ßn k√Ω..."
                                style="min-height: 80px;"></textarea>
                            <div class="error-message" id="verifyMessageError"></div>
                        </div>

                        <!-- Input file -->
                        <div id="demoVerifyFileInput" class="form-group full-width" style="display: none;">
                            <label style="color: #1565c0; font-weight: 600;">File c·∫ßn x√°c th·ª±c:</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="verifyFile"
                                    onclick="resetFileInput('verifyFile')"
                                    onchange="updateFileName('verifyFile', 'verifyFileName'); previewFileContent('verifyFile', 'verifyFilePreview', 'verifyFileContent')">
                                <label for="verifyFile" class="file-input-label">
                                    Ch·ªçn File
                                </label>
                                <span class="file-name" id="verifyFileName">Ch∆∞a ch·ªçn file</span>
                            </div>
                            <div id="verifyFilePreview"
                                style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; display: none; max-height: 100px; overflow-y: auto;">
                                <strong style="color: #1565c0; font-size: 13px;">N·ªôi dung:</strong>
                                <pre id="verifyFileContent"
                                    style="margin: 5px 0 0 0; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Inter', sans-serif;"></pre>
                            </div>
                            <div class="error-message" id="verifyFileError"></div>
                        </div>

                        <button class="btn btn-success btn-block full-width" onclick="demoVerify()">
                            X√°c th·ª±c
                        </button>
                    </div>

                    <div class="loading" id="demoVerifyLoading">
                        <div class="spinner"></div>
                        <p>ƒêang x√°c th·ª±c...</p>
                    </div>

                    <div id="demoVerifyResult"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Sign & Verify File with Generated Keys -->
        <div class="tab-content" id="sign-file">
            <h2>K√Ω & X√°c th·ª±c v·ªõi Kh√≥a Sinh T·ª± ƒë·ªông</h2>

            <!-- Key Status -->
            <div class="key-status" id="keyStatus">
                <h3>Tr·∫°ng th√°i Kh√≥a</h3>
                <div class="key-info">
                    <div class="key-item no-key" id="privateKeyStatus">
                        <strong>Private Key:</strong> <span id="privateKeyText">Ch∆∞a c√≥</span>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">D√πng ƒë·ªÉ k√Ω vƒÉn b·∫£n/file</div>
                    </div>
                    <div class="key-item no-key" id="publicKeyStatus">
                        <strong>Public Key:</strong> <span id="publicKeyText">Ch∆∞a c√≥</span>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">D√πng ƒë·ªÉ x√°c th·ª±c ch·ªØ k√Ω</div>
                    </div>
                </div>
                <div id="keyRoleWarning"
                    style="display: none; margin-top: 15px; padding: 12px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; color: #856404;">
                    <strong>L∆∞u √Ω:</strong> B·∫°n ch·ªâ c√≥ Public Key. B·∫°n c√≥ th·ªÉ x√°c th·ª±c ch·ªØ k√Ω nh∆∞ng kh√¥ng th·ªÉ k√Ω vƒÉn
                    b·∫£n/file.
                </div>
                <div class="key-actions">
                    <button class="btn btn-primary" onclick="generateKeys()"
                        title="T·∫°o c·∫∑p kh√≥a m·ªõi (Private + Public)">
                        T·∫°o Kh√≥a M·ªõi
                    </button>
                    <button class="btn btn-success" id="exportPublicBtn" onclick="exportKey('public')" disabled
                        title="Chia s·∫ª cho ng∆∞·ªùi kh√°c ƒë·ªÉ h·ªç x√°c th·ª±c ch·ªØ k√Ω c·ªßa b·∫°n">
                        Xu·∫•t Public Key
                    </button>
                    <button class="btn btn-success" id="exportPrivateBtn" onclick="exportKey('private')"
                        style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%); box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);"
                        disabled title="Sao l∆∞u ƒë·ªÉ k√Ω tr√™n thi·∫øt b·ªã kh√°c (B·∫¢O M·∫¨T!)">
                        Xu·∫•t Private Key
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importKeyFile').click()"
                        title="Nh·∫≠p Public Key (x√°c th·ª±c) ho·∫∑c Private Key (k√Ω)">
                        Nh·∫≠p Key
                    </button>
                    <button class="btn btn-danger" id="clearKeysBtn" onclick="clearKeys()" disabled
                        title="X√≥a t·∫•t c·∫£ kh√≥a kh·ªèi session">
                        X√≥a Kh√≥a
                    </button>
                </div>
                <input type="file" id="importKeyFile" style="display:none" accept=".json" onchange="importKey(this)">
            </div>

            <!-- DSA Parameters Display -->
            <div class="key-status" id="dsaParamsSection" style="display: none;">
                <h3>Tham s·ªë DSA</h3>
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #dee2e6;">
                            <strong style="color: #667eea; font-size: 16px;">Tham s·ªë p (s·ªë nguy√™n t·ªë):</strong>
                            <div id="dsaParamP" style="font-family: monospace; font-size: 13px; color: #333; margin-top: 8px; word-break: break-all; line-height: 1.5;">-</div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #dee2e6;">
                            <strong style="color: #667eea; font-size: 16px;">Tham s·ªë q (s·ªë nguy√™n t·ªë):</strong>
                            <div id="dsaParamQ" style="font-family: monospace; font-size: 13px; color: #333; margin-top: 8px; word-break: break-all; line-height: 1.5;">-</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #dee2e6;">
                            <strong style="color: #667eea; font-size: 16px;">Tham s·ªë g (generator):</strong>
                            <div id="dsaParamG" style="font-family: monospace; font-size: 13px; color: #333; margin-top: 8px; word-break: break-all; line-height: 1.5;">-</div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #28a745;">
                            <strong style="color: #28a745; font-size: 16px;">Public Key y (duy nh·∫•t):</strong>
                            <div id="dsaParamY" style="font-family: monospace; font-size: 13px; color: #333; margin-top: 8px; word-break: break-all; line-height: 1.5;">-</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 8px;">
                        <strong style="color: #1565c0; font-size: 15px;">üìå Gi·∫£i th√≠ch:</strong>
                        <ul style="margin: 10px 0 0 20px; color: #0d47a1; font-size: 14px; line-height: 1.8;">
                            <li><strong>p, q, g</strong> l√† <strong>Domain Parameters</strong> theo ti√™u chu·∫©n <strong>FIPS 186-4</strong> (ƒë∆∞·ª£c NIST c√¥ng nh·∫≠n) - c·ªë ƒë·ªãnh v√† chia s·∫ª chung cho t·∫•t c·∫£ ng∆∞·ªùi d√πng.</li>
                            <li><strong>Public Key (y)</strong> l√† gi√° tr·ªã <strong>DUY NH·∫§T</strong> cho m·ªói ng∆∞·ªùi d√πng, ƒë∆∞·ª£c t√≠nh t·ª´ Private Key: y = g^x mod p</li>
                            <li>Vi·ªác d√πng tham s·ªë chu·∫©n FIPS 186-4 ƒë·∫£m b·∫£o t√≠nh an to√†n ƒë√£ ƒë∆∞·ª£c ki·ªÉm ch·ª©ng v√† t∆∞∆°ng th√≠ch v·ªõi c√°c h·ªá th·ªëng DSA kh√°c.</li>
                            <li><strong>ƒê·ªô d√†i kh√≥a:</strong> p = 1024 bits, q = 160 bits (m·ª©c b·∫£o m·∫≠t chu·∫©n)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div
                style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div class="guide-header" onclick="toggleGuide('fileGuide', 'fileGuideIcon')">
                    <h4 style="color: #1976d2; margin: 0; font-size: 20px; font-weight: 600;">üìò H∆∞·ªõng d·∫´n K√Ω & X√°c th·ª±c
                        File</h4>
                    <button class="guide-toggle" id="fileGuideIcon">‚ñº</button>
                </div>
                <div class="guide-content collapsed" id="fileGuide"
                    style="color: #0d47a1; line-height: 1.8; font-size: 17px; margin-top: 12px;">
                    <p style="margin: 0 0 10px 0;"><strong>M·ª•c ƒë√≠ch:</strong> K√Ω v√† x√°c th·ª±c file th·ª±c t·∫ø v·ªõi kh√≥a DSA
                        t·ª± ƒë·ªông sinh (b·∫£o m·∫≠t cao).</p>
                    <ol style="margin: 0 0 10px 0; padding-left: 25px;">
                        <li style="margin-bottom: 6px;"><strong>B∆∞·ªõc 1:</strong> Nh·∫•n "T·∫°o Kh√≥a M·ªõi" ho·∫∑c "Import Key"
                            ƒë·ªÉ c√≥ c·∫∑p kh√≥a.</li>
                        <li style="margin-bottom: 6px;"><strong>B∆∞·ªõc 2:</strong> Ch·ªçn file c·∫ßn k√Ω, nh·∫•n "K√Ω File", t·∫£i
                            file .sig v·ªÅ m√°y.</li>
                        <li style="margin-bottom: 6px;"><strong>B∆∞·ªõc 3:</strong> Upload file g·ªëc + file .sig, nh·∫•n "X√°c
                            th·ª±c File".</li>
                        <li><strong>B∆∞·ªõc 4:</strong> Export Public Key ƒë·ªÉ chia s·∫ª, Private Key ƒë·ªÉ sao l∆∞u (B·∫¢O M·∫¨T!).
                        </li>
                    </ol>
                    <p
                        style="margin: 0; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 16px;">
                        üîí Private Key d√πng ƒë·ªÉ K√ù (gi·ªØ b√≠ m·∫≠t). Public Key d√πng ƒë·ªÉ X√ÅC TH·ª∞C (c√≥ th·ªÉ chia s·∫ª).</p>
                </div>
            </div>

            <!-- B·ªê TR√ç NGANG: K√ù FILE B√äN TR√ÅI - X√ÅC TH·ª∞C FILE B√äN PH·∫¢I -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">

                <!-- PH·∫¶N K√ù FILE (B√äN TR√ÅI) -->
                <div
                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 3px solid #4caf50; border-radius: 12px; padding: 20px;">
                    <h3
                        style="color: #2e7d32; margin-bottom: 20px; font-size: 20px; text-align: center; font-weight: 700;">
                        K√ù FILE</h3>

                    <div class="alert" id="signFileAlert"></div>

                    <div id="privateKeyNotice"
                        style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #856404; font-size: 16px;">
                        <strong>L∆∞u √Ω:</strong> <span id="privateKeyNoticeText">C·∫ßn c√≥ Private Key ƒë·ªÉ k√Ω file</span>
                    </div>

                    <div class="form-group">
                        <label style="color: #2e7d32; font-weight: 600;">Ch·ªçn file c·∫ßn k√Ω:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="fileToSign"
                                onchange="updateFileName('fileToSign', 'fileToSignName'); previewFileContent('fileToSign', 'fileSignPreview', 'fileSignContent')">
                            <label for="fileToSign" class="file-input-label">
                                Ch·ªçn File
                            </label>
                            <span class="file-name" id="fileToSignName">Ch∆∞a ch·ªçn file</span>
                        </div>
                    </div>

                    <div id="fileSignPreview"
                        style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none; max-height: 200px; overflow-y: auto;">
                        <strong style="color: #2e7d32;">N·ªôi dung file:</strong>
                        <pre id="fileSignContent"
                            style="margin: 10px 0 0 0; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Inter', sans-serif;"></pre>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="signFile()">
                        K√Ω File
                    </button>

                    <div class="loading" id="signFileLoading">
                        <div class="spinner"></div>
                        <p>ƒêang k√Ω file...</p>
                    </div>

                    <div id="signFileResult"></div>
                </div>

                <!-- PH·∫¶N X√ÅC TH·ª∞C FILE (B√äN PH·∫¢I) -->
                <div
                    style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 3px solid #2196f3; border-radius: 12px; padding: 20px;">
                    <h3
                        style="color: #1565c0; margin-bottom: 20px; font-size: 20px; text-align: center; font-weight: 700;">
                        X√ÅC TH·ª∞C FILE</h3>

                    <div class="alert" id="verifyFileAlert"></div>

                    <div id="publicKeyNotice"
                        style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #856404; font-size: 16px;">
                        <strong>L∆∞u √Ω:</strong> <span id="publicKeyNoticeText">C·∫ßn c√≥ Public Key ƒë·ªÉ x√°c th·ª±c file</span>
                    </div>

                    <div class="form-group">
                        <label style="color: #1565c0; font-weight: 600;">File g·ªëc:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="fileToVerify"
                                onclick="resetFileInput('fileToVerify')"
                                onchange="updateFileName('fileToVerify', 'fileToVerifyName'); previewFileContent('fileToVerify', 'fileVerifyPreview', 'fileVerifyContent')">
                            <label for="fileToVerify" class="file-input-label">
                                Ch·ªçn File
                            </label>
                            <span class="file-name" id="fileToVerifyName">Ch∆∞a ch·ªçn file</span>
                        </div>
                    </div>

                    <div id="fileVerifyPreview"
                        style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none; max-height: 200px; overflow-y: auto;">
                        <strong style="color: #1565c0;">N·ªôi dung file:</strong>
                        <pre id="fileVerifyContent"
                            style="margin: 10px 0 0 0; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Inter', sans-serif;"></pre>
                    </div>

                    <div class="form-group">
                        <label style="color: #1565c0; font-weight: 600;">File ch·ªØ k√Ω (.sig):</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="signatureFile" accept=".sig,.json"
                                onchange="updateFileName('signatureFile', 'signatureFileName')">
                            <label for="signatureFile" class="file-input-label">
                                Ch·ªçn File Ch·ªØ k√Ω
                            </label>
                            <span class="file-name" id="signatureFileName">Ch∆∞a ch·ªçn file</span>
                        </div>
                    </div>

                    <button class="btn btn-success btn-block" onclick="verifyFile()">
                        X√°c th·ª±c File
                    </button>

                    <div class="loading" id="verifyFileLoading">
                        <div class="spinner"></div>
                        <p>ƒêang x√°c th·ª±c...</p>
                    </div>

                    <div id="verifyFileResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>¬© 2025 DSA Digital Signature System | <strong>Nh√≥m 4</strong> - An ninh m·∫°ng</p>
    </div>

    <script>
        // L∆∞u k·∫øt qu·∫£ k√Ω g·∫ßn nh·∫•t ƒë·ªÉ so s√°nh khi x√°c th·ª±c
        let lastDemoSignResult = null;

        // Switch tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Reset d·ªØ li·ªáu khi chuy·ªÉn tab
            if (tabId === 'demo-algorithm') {
                // Chuy·ªÉn sang Demo Algorithm - reset t·∫•t c·∫£
                resetDemoAlgorithm();
            } else if (tabId === 'sign-file') {
                // Chuy·ªÉn sang DSA v·ªõi kh√≥a t·ª± ƒë·ªông - reset t·∫•t c·∫£
                resetAutoKeySection();
            }
        }

        // Reset ph·∫ßn Demo Algorithm
        function resetDemoAlgorithm() {
            // Reset t·∫•t c·∫£ input fields
            document.getElementById('demoP').value = '';
            document.getElementById('demoQ').value = '';
            document.getElementById('demoG').value = '';
            document.getElementById('demoX').value = '';
            document.getElementById('demoK').value = '';
            document.getElementById('demoMessage').value = '';
            document.getElementById('demoFile').value = '';
            document.getElementById('demoFileName').textContent = 'Ch∆∞a ch·ªçn file';
            document.getElementById('demoFilePreview').style.display = 'none';
            
            // Reset verify fields
            document.getElementById('verifyP').value = '';
            document.getElementById('verifyQ').value = '';
            document.getElementById('verifyG').value = '';
            document.getElementById('verifyY').value = '';
            document.getElementById('verifyR').value = '';
            document.getElementById('verifyS').value = '';
            document.getElementById('verifyMessage').value = '';
            document.getElementById('verifyFile').value = '';
            document.getElementById('verifyFileName').textContent = 'Ch∆∞a ch·ªçn file';
            document.getElementById('verifyFilePreview').style.display = 'none';
            
            // Clear results
            document.getElementById('demoResult').innerHTML = '';
            document.getElementById('demoVerifyResult').innerHTML = '';
            
            // Clear all errors
            clearAllDemoErrors();
            clearFieldError('verifyP');
            clearFieldError('verifyQ');
            clearFieldError('verifyG');
            clearFieldError('verifyY');
            clearFieldError('verifyR');
            clearFieldError('verifyS');
            clearFieldError('verifyMessage');
            clearFieldError('verifyFile');
            
            // Clear alerts
            const signAlert = document.getElementById('demoSignAlert');
            const verifyAlert = document.getElementById('demoVerifyAlert');
            if (signAlert) signAlert.classList.remove('show');
            if (verifyAlert) verifyAlert.classList.remove('show');
        }

        // Reset ph·∫ßn DSA v·ªõi kh√≥a t·ª± ƒë·ªông
        function resetAutoKeySection() {
            // Reset file inputs
            document.getElementById('fileToSign').value = '';
            document.getElementById('fileToSignName').textContent = 'Ch∆∞a ch·ªçn file';
            document.getElementById('fileSignPreview').style.display = 'none';
            
            document.getElementById('fileToVerify').value = '';
            document.getElementById('fileToVerifyName').textContent = 'Ch∆∞a ch·ªçn file';
            document.getElementById('fileVerifyPreview').style.display = 'none';
            
            document.getElementById('signatureFile').value = '';
            document.getElementById('signatureFileName').textContent = 'Ch∆∞a ch·ªçn file';
            
            // Clear results
            document.getElementById('signFileResult').innerHTML = '';
            document.getElementById('verifyFileResult').innerHTML = '';
            
            // Clear alerts
            const signAlert = document.getElementById('signFileAlert');
            const verifyAlert = document.getElementById('verifyFileAlert');
            if (signAlert) signAlert.classList.remove('show');
            if (verifyAlert) verifyAlert.classList.remove('show');
        }

        // Toggle guide sections
        function toggleGuide(guideId, iconId) {
            const guide = document.getElementById(guideId);
            const icon = document.getElementById(iconId);
            guide.classList.toggle('collapsed');
            icon.textContent = guide.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
        }

        // Update key status
        async function updateKeyStatus() {
            try {
                const response = await fetch('/api/get-key-status');
                const data = await response.json();

                if (data.success) {
                    const status = data.status;

                    // Private key
                    const privateKeyStatus = document.getElementById('privateKeyStatus');
                    const privateKeyText = document.getElementById('privateKeyText');
                    if (status.has_private) {
                        privateKeyStatus.classList.remove('no-key');
                        privateKeyStatus.classList.add('has-key');
                        privateKeyText.textContent = status.private_key;
                    } else {
                        privateKeyStatus.classList.remove('has-key');
                        privateKeyStatus.classList.add('no-key');
                        privateKeyText.textContent = 'Ch∆∞a c√≥';
                    }

                    // Public key
                    const publicKeyStatus = document.getElementById('publicKeyStatus');
                    const publicKeyText = document.getElementById('publicKeyText');
                    if (status.has_public) {
                        publicKeyStatus.classList.remove('no-key');
                        publicKeyStatus.classList.add('has-key');
                        publicKeyText.textContent = status.public_key;
                    } else {
                        publicKeyStatus.classList.remove('has-key');
                        publicKeyStatus.classList.add('no-key');
                        publicKeyText.textContent = 'Ch∆∞a c√≥';
                    }

                    // Update DSA parameters display
                    updateDSAParams(status);

                    // Update button states
                    updateButtonStates(status);

                    // Update key notice colors
                    updateKeyNotices(status);
                }
            } catch (error) {
                console.error('Error updating key status:', error);
            }
        }

        // Update DSA parameters display
        function updateDSAParams(status) {
            const dsaSection = document.getElementById('dsaParamsSection');
            
            if (status.dsa_params) {
                // Hi·ªÉn th·ªã section
                dsaSection.style.display = 'block';
                
                // C·∫≠p nh·∫≠t c√°c gi√° tr·ªã
                document.getElementById('dsaParamP').textContent = status.dsa_params.p || '-';
                document.getElementById('dsaParamQ').textContent = status.dsa_params.q || '-';
                document.getElementById('dsaParamG').textContent = status.dsa_params.g || '-';
                document.getElementById('dsaParamY').textContent = status.dsa_params.y || '-';
            } else {
                // ·∫®n section n·∫øu kh√¥ng c√≥ tham s·ªë
                dsaSection.style.display = 'none';
            }
        }

        // Update button states based on key availability
        function updateButtonStates(status) {
            const exportPublicBtn = document.getElementById('exportPublicBtn');
            const exportPrivateBtn = document.getElementById('exportPrivateBtn');
            const clearKeysBtn = document.getElementById('clearKeysBtn');
            const keyRoleWarning = document.getElementById('keyRoleWarning');

            // Enable/disable export public key button
            if (status.has_public) {
                exportPublicBtn.disabled = false;
            } else {
                exportPublicBtn.disabled = true;
            }

            // Enable/disable export private key button
            if (status.has_private) {
                exportPrivateBtn.disabled = false;
            } else {
                exportPrivateBtn.disabled = true;
            }

            // Enable/disable clear keys button (if has any key)
            if (status.has_private || status.has_public) {
                clearKeysBtn.disabled = false;
            } else {
                clearKeysBtn.disabled = true;
            }

            // Show warning if only has public key (can't sign)
            if (status.has_public && !status.has_private) {
                keyRoleWarning.style.display = 'block';
            } else {
                keyRoleWarning.style.display = 'none';
            }
        }

        // Update key notices color based on key availability
        function updateKeyNotices(status) {
            const privateKeyNotice = document.getElementById('privateKeyNotice');
            const privateKeyNoticeText = document.getElementById('privateKeyNoticeText');
            const publicKeyNotice = document.getElementById('publicKeyNotice');
            const publicKeyNoticeText = document.getElementById('publicKeyNoticeText');

            // Update Private Key notice
            if (privateKeyNotice && privateKeyNoticeText) {
                if (status.has_private) {
                    privateKeyNotice.style.background = '#d4edda';
                    privateKeyNotice.style.borderColor = '#28a745';
                    privateKeyNotice.style.color = '#155724';
                    privateKeyNoticeText.textContent = 'ƒê√£ c√≥ Private Key - S·∫µn s√†ng k√Ω file!';
                } else {
                    privateKeyNotice.style.background = '#fff3cd';
                    privateKeyNotice.style.borderColor = '#ffc107';
                    privateKeyNotice.style.color = '#856404';
                    privateKeyNoticeText.textContent = 'C·∫ßn c√≥ Private Key ƒë·ªÉ k√Ω file';
                }
            }

            // Update Public Key notice
            if (publicKeyNotice && publicKeyNoticeText) {
                if (status.has_public) {
                    publicKeyNotice.style.background = '#d4edda';
                    publicKeyNotice.style.borderColor = '#28a745';
                    publicKeyNotice.style.color = '#155724';
                    publicKeyNoticeText.textContent = 'ƒê√£ c√≥ Public Key - S·∫µn s√†ng x√°c th·ª±c!';
                } else {
                    publicKeyNotice.style.background = '#fff3cd';
                    publicKeyNotice.style.borderColor = '#ffc107';
                    publicKeyNotice.style.color = '#856404';
                    publicKeyNoticeText.textContent = 'C·∫ßn c√≥ Public Key ƒë·ªÉ x√°c th·ª±c file';
                }
            }
        }

        // Generate keys
        async function generateKeys() {
            try {
                const response = await fetch('/api/generate-keys', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    // Hi·ªÉn th·ªã alert ·ªü tab hi·ªán t·∫°i
                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.message, 'success');
                    } else {
                        alert(data.message); // Fallback
                    }
                    await updateKeyStatus();
                } else {
                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.error, 'error');
                    } else {
                        alert(data.error); // Fallback
                    }
                }
            } catch (error) {
                const activeTab = document.querySelector('.tab-content.active');
                const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                if (alertDiv) {
                    showAlert(alertDiv.id, 'L·ªói: ' + error.message, 'error');
                } else {
                    alert('L·ªói: ' + error.message); // Fallback
                }
            }
        }



        // Sign file
        async function signFile() {
            const fileInput = document.getElementById('fileToSign');

            if (!fileInput.files.length) {
                showAlert('signFileAlert', 'Vui l√≤ng ch·ªçn file!', 'error');
                return;
            }

            // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (fileInput.files[0].size > maxSize) {
                showAlert('signFileAlert', 'File qu√° l·ªõn! Gi·ªõi h·∫°n 10MB', 'error');
                return;
            }

            showLoading('signFileLoading', true);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/sign-file', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                showLoading('signFileLoading', false);

                if (data.success) {
                    showAlert('signFileAlert', data.message, 'success');

                    const resultDiv = document.getElementById('signFileResult');

                    // Store signature content globally to avoid escaping issues
                    window.currentSignatureContent = data.signature_content;
                    window.currentSignatureFilename = data.signature_file;

                    // Parse signature to display r and s
                    let sigDisplay = '';
                    try {
                        const sigData = JSON.parse(data.signature_content);
                        sigDisplay = `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px;">
                                <strong style="color: #667eea;">Ch·ªØ k√Ω:</strong>
                                <p style="margin: 8px 0;"><strong>r:</strong> <code style="font-size: 14px; word-break: break-all;">0x${sigData.signature.r}</code></p>
                                <p style="margin: 8px 0;"><strong>s:</strong> <code style="font-size: 14px; word-break: break-all;">0x${sigData.signature.s}</code></p>
                            </div>
                        `;
                    } catch (e) {
                        sigDisplay = '';
                    }

                    resultDiv.innerHTML = `
                        <div class="result-box" style="border-color: #28a745;">
                            <h4 style="color: #28a745;">ƒê√£ k√Ω file th√†nh c√¥ng!</h4>
                            <p><strong>File g·ªëc:</strong> ${data.filename}</p>
                            <p><strong>File ch·ªØ k√Ω:</strong> ${data.signature_file}</p>
                            ${sigDisplay}
                            <hr style="margin: 15px 0; border: none; border-top: 1px solid #dee2e6;">
                            <button class="btn btn-success" style="margin-top: 15px;" onclick="downloadCurrentSignature()">
                                T·∫£i xu·ªëng File Ch·ªØ K√Ω (.sig)
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; color: #6c757d;"><em>Th·ªùi gian k√Ω: ${new Date().toLocaleString('vi-VN')}</em></p>
                            <p style="margin-top: 5px; font-size: 14px; color: #28a745;"><strong>L∆∞u √Ω:</strong> T·∫£i xu·ªëng file ch·ªØ k√Ω ƒë·ªÉ c√≥ th·ªÉ x√°c th·ª±c sau n√†y</p>
                        </div>
                    `;
                } else {
                    showAlert('signFileAlert', data.error, 'error');
                }
            } catch (error) {
                showLoading('signFileLoading', false);
                showAlert('signFileAlert', 'L·ªói: ' + error.message, 'error');
            }
        }

        // Verify file
        async function verifyFile() {
            const fileInput = document.getElementById('fileToVerify');
            const sigInput = document.getElementById('signatureFile');

            if (!fileInput.files.length || !sigInput.files.length) {
                showAlert('verifyFileAlert', 'Vui l√≤ng ch·ªçn c·∫£ file v√† ch·ªØ k√Ω!', 'error');
                return;
            }

            // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (fileInput.files[0].size > maxSize) {
                showAlert('verifyFileAlert', 'File qu√° l·ªõn! Gi·ªõi h·∫°n 10MB', 'error');
                return;
            }

            // Ki·ªÉm tra file signature ph·∫£i l√† .sig ho·∫∑c .json
            const sigFileName = sigInput.files[0].name;
            if (!sigFileName.endsWith('.sig') && !sigFileName.endsWith('.json')) {
                showAlert('verifyFileAlert', 'File ch·ªØ k√Ω ph·∫£i c√≥ ƒëu√¥i .sig ho·∫∑c .json!', 'error');
                return;
            }

            showLoading('verifyFileLoading', true);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('signature', sigInput.files[0]);

            try {
                const response = await fetch('/api/verify-file', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                showLoading('verifyFileLoading', false);

                if (data.success) {
                    const type = data.valid ? 'success' : 'error';
                    showAlert('verifyFileAlert', data.message, type);

                    const resultDiv = document.getElementById('verifyFileResult');
                    const publicKeyInfo = data.public_key_used ?
                        `<p><strong>Public Key s·ª≠ d·ª•ng:</strong> ${data.public_key_used}</p>` :
                        '<p><strong>C·∫£nh b√°o:</strong> Kh√¥ng t√¨m th·∫•y public key trong file ch·ªØ k√Ω</p>';

                    const statusColor = data.valid ? '#28a745' : '#dc3545';

                    // X√°c ƒë·ªãnh th√¥ng b√°o l·ªói c·ª• th·ªÉ
                    let errorMessage = '';
                    
                    if (!data.valid && data.error_type) {
                        switch (data.error_type) {
                            case 'PUBLIC_KEY_MISMATCH':
                                errorMessage = 'Public Key kh√¥ng kh·ªõp v·ªõi ng∆∞·ªùi k√Ω';
                                break;
                            case 'FILE_MODIFIED':
                                errorMessage = 'File ƒë√£ b·ªã thay ƒë·ªïi';
                                break;
                            case 'INVALID_SIGNATURE_R':
                            case 'INVALID_SIGNATURE_S':
                                errorMessage = 'Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá';
                                break;
                            case 'INVALID_PUBLIC_KEY':
                                errorMessage = 'Public Key kh√¥ng h·ª£p l·ªá';
                                break;
                            case 'VERIFICATION_FAILED':
                            case 'UNKNOWN':
                            default:
                                errorMessage = 'X√°c th·ª±c th·∫•t b·∫°i';
                                break;
                        }
                    }

                    // Error message section
                    const errorHtml = (!data.valid && errorMessage) ? `
                        <div style="margin-top: 15px; background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 16px;">
                            <strong style="color: #721c24; font-size: 18px; display: block;">‚ùå ${errorMessage}</strong>
                        </div>
                    ` : '';

                    resultDiv.innerHTML = `
                        <div class="result-box" style="border-color: ${statusColor};">
                            <h4 style="color: ${statusColor};">K·∫øt qu·∫£: ${data.valid ? '‚úÖ H·ª¢P L·ªÜ' : '‚ùå KH√îNG H·ª¢P L·ªÜ'}</h4>
                            <p style="margin-bottom: 10px; font-size: 16px;">${data.valid ? 'File ch∆∞a b·ªã thay ƒë·ªïi, ch·ªØ k√Ω h·ª£p l·ªá.' : ''}</p>
                            ${errorHtml}
                            <hr style="margin: 15px 0; border: none; border-top: 1px solid #dee2e6;">
                            ${publicKeyInfo}
                            <p style="margin-top: 10px; font-size: 14px; color: #6c757d;"><em>Th·ªùi gian x√°c th·ª±c: ${new Date().toLocaleString('vi-VN')}</em></p>
                        </div>
                    `;
                } else {
                    showAlert('verifyFileAlert', data.error, 'error');
                }
            } catch (error) {
                showLoading('verifyFileLoading', false);
                showAlert('verifyFileAlert', 'L·ªói: ' + error.message, 'error');
            }
        }

        // Export key
        async function exportKey(type) {
            // Check if button is disabled
            const btn = type === 'public' ? document.getElementById('exportPublicBtn') : document.getElementById('exportPrivateBtn');
            if (btn.disabled) {
                alert(`Ch∆∞a c√≥ ${type === 'public' ? 'public' : 'private'} key ƒë·ªÉ xu·∫•t!`);
                return;
            }

            try {
                const response = await fetch('/api/export-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                const data = await response.json();

                if (data.success) {
                    // Download file
                    const blob = new Blob([data.data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${type}_key.json`;
                    a.click();

                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                } else {
                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.error, 'error');
                    } else {
                        alert(data.error);
                    }
                }
            } catch (error) {
                const activeTab = document.querySelector('.tab-content.active');
                const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                if (alertDiv) {
                    showAlert(alertDiv.id, 'L·ªói: ' + error.message, 'error');
                } else {
                    alert('L·ªói: ' + error.message);
                }
            }
        }

        // Import key
        async function importKey(input) {
            if (!input.files.length) return;

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const response = await fetch('/api/import-key', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    let message = data.message;
                    // Add extra info based on key type
                    if (data.message.includes('public key')) {
                        message += ' (Ch·ªâ c√≥ th·ªÉ x√°c th·ª±c, kh√¥ng th·ªÉ k√Ω)';
                    } else if (data.message.includes('private key')) {
                        message += ' (C√≥ th·ªÉ k√Ω v√† x√°c th·ª±c)';
                    }

                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, message, 'success');
                    } else {
                        alert(message);
                    }
                    await updateKeyStatus();
                } else {
                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.error, 'error');
                    } else {
                        alert(data.error);
                    }
                }
            } catch (error) {
                const activeTab = document.querySelector('.tab-content.active');
                const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                if (alertDiv) {
                    showAlert(alertDiv.id, 'L·ªói: ' + error.message, 'error');
                } else {
                    alert('L·ªói: ' + error.message);
                }
            }

            input.value = '';
        }

        // Clear keys
        async function clearKeys() {
            // Check if button is disabled
            const btn = document.getElementById('clearKeysBtn');
            if (btn.disabled) {
                alert('Kh√¥ng c√≥ kh√≥a n√†o ƒë·ªÉ x√≥a!');
                return;
            }

            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ kh√≥a?')) return;

            try {
                const response = await fetch('/api/clear-keys', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    await updateKeyStatus();
                } else {
                    const activeTab = document.querySelector('.tab-content.active');
                    const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                    if (alertDiv) {
                        showAlert(alertDiv.id, data.error, 'error');
                    } else {
                        alert(data.error);
                    }
                }
            } catch (error) {
                const activeTab = document.querySelector('.tab-content.active');
                const alertDiv = activeTab ? activeTab.querySelector('.alert') : null;
                if (alertDiv) {
                    showAlert(alertDiv.id, 'L·ªói: ' + error.message, 'error');
                } else {
                    alert('L·ªói: ' + error.message);
                }
            }
        }

        // Helper functions
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;

            // TƒÉng th·ªùi gian hi·ªÉn th·ªã l√™n 15 gi√¢y
            setTimeout(() => {
                alert.classList.remove('show');
            }, 15000);
        }

        function showLoading(elementId, show) {
            const loading = document.getElementById(elementId);
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }



        function downloadSignature(content, filename) {
            // T·∫°o blob t·ª´ n·ªôi dung signature
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadCurrentSignature() {
            if (window.currentSignatureContent && window.currentSignatureFilename) {
                downloadSignature(window.currentSignatureContent, window.currentSignatureFilename);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y file ch·ªØ k√Ω!');
            }
        }

        // Helper function to show alert in correct section
        function showDemoAlert(section, message, type) {
            const alertId = section === 'sign' ? 'demoSignAlert' : 'demoVerifyAlert';
            showAlert(alertId, message, type);
        }

        function updateFileName(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            if (input.files.length) {
                const file = input.files[0];
                const fileSize = (file.size / 1024).toFixed(2); // KB
                const sizeText = fileSize > 1024 ?
                    `${(fileSize / 1024).toFixed(2)} MB` :
                    `${fileSize} KB`;
                display.textContent = `${file.name} (${sizeText})`;
                display.style.color = '#28a745';
                display.style.fontWeight = '600';
            } else {
                display.textContent = 'Ch∆∞a ch·ªçn file';
                display.style.color = '#666';
                display.style.fontWeight = 'normal';
            }
        }

        function previewFileContent(inputId, previewId, contentId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const content = document.getElementById(contentId);

            // X√≥a n·ªôi dung c≈© tr∆∞·ªõc
            content.innerHTML = '';
            preview.style.display = 'none';

            if (input.files.length) {
                const file = input.files[0];
                const fileName = file.name.toLowerCase();
                const fileSize = (file.size / 1024).toFixed(2);
                
                // Danh s√°ch extension c·ªßa file c√≥ th·ªÉ ƒë·ªçc
                const textExtensions = ['.txt', '.md', '.json', '.xml', '.csv', '.log', '.py', '.js', '.html', '.css', '.java', '.c', '.cpp', '.h'];
                const docExtensions = ['.docx', '.pdf'];
                const isTextFile = textExtensions.some(ext => fileName.endsWith(ext));
                const isDocFile = docExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isTextFile && !isDocFile) {
                    // File binary kh√¥ng h·ªó tr·ª£ - ch·ªâ hi·ªÉn th·ªã th√¥ng tin
                    content.innerHTML = `<strong style="color: #856404;">‚ö†Ô∏è File binary kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£</strong><br>
                        <span style="font-size: 13px;">T√™n file: ${file.name}</span><br>
                        <span style="font-size: 13px;">K√≠ch th∆∞·ªõc: ${fileSize} KB</span><br>
                        <span style="font-size: 13px; color: #dc3545;">Ch·ªâ h·ªó tr·ª£: .txt, .docx, .pdf v√† c√°c file text kh√°c.</span>`;
                    preview.style.display = 'block';
                    return;
                }
                
                if (isDocFile) {
                    // File .docx ho·∫∑c .pdf - g·ª≠i l√™n server ƒë·ªÉ preview
                    content.innerHTML = `<strong style="color: #2196f3;">‚è≥ ƒêang tr√≠ch xu·∫•t n·ªôi dung...</strong><br>
                        <span style="font-size: 13px;">T√™n file: ${file.name}</span><br>
                        <span style="font-size: 13px;">K√≠ch th∆∞·ªõc: ${fileSize} KB</span>`;
                    preview.style.display = 'block';
                    
                    // G·ª≠i file l√™n server ƒë·ªÉ preview
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    fetch('/api/preview-file', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const truncatedMsg = data.truncated ? ` (hi·ªÉn th·ªã ${data.content.length}/${data.full_length} k√Ω t·ª±)` : '';
                            content.innerHTML = `<strong style="color: #28a745;">‚úì ƒê√£ tr√≠ch xu·∫•t n·ªôi dung${truncatedMsg}</strong><br>
                                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${data.content}</div>`;
                        } else {
                            content.innerHTML = `<strong style="color: #dc3545;">‚ùå Kh√¥ng th·ªÉ tr√≠ch xu·∫•t n·ªôi dung</strong><br>
                                <span style="font-size: 13px;">${data.error}</span>`;
                        }
                    })
                    .catch(error => {
                        content.innerHTML = `<strong style="color: #dc3545;">‚ùå L·ªói khi tr√≠ch xu·∫•t</strong><br>
                            <span style="font-size: 13px;">${error.message}</span>`;
                    });
                    
                    return;
                }
                
                // File text - ƒë·ªçc v√† hi·ªÉn th·ªã n·ªôi dung
                const reader = new FileReader();

                reader.onload = function (e) {
                    const text = e.target.result;
                    const previewText = text.length > 300 ? text.substring(0, 300) + '...' : text;
                    content.textContent = previewText;
                    preview.style.display = 'block';
                };

                reader.onerror = function () {
                    content.innerHTML = '<strong style="color: #dc3545;">‚ùå Kh√¥ng th·ªÉ ƒë·ªçc file</strong><br><span style="font-size: 13px;">File c√≥ th·ªÉ b·ªã h·ªèng ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.</span>';
                    preview.style.display = 'block';
                };

                reader.readAsText(file, 'UTF-8');
            } else {
                preview.style.display = 'none';
            }
        }

        // H√†m reset file input ƒë·ªÉ ƒë·∫£m b·∫£o onchange lu√¥n ƒë∆∞·ª£c k√≠ch ho·∫°t
        function resetFileInput(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
            }
        }

        // Error handling functions
        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            if (field) {
                field.classList.remove('error');
            }
            if (errorDiv) {
                errorDiv.classList.remove('show');
                errorDiv.textContent = '';
            }
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            if (field) {
                field.classList.add('error');
            }
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
            }
        }

        function clearAllDemoErrors() {
            clearFieldError('demoP');
            clearFieldError('demoQ');
            clearFieldError('demoG');
            clearFieldError('demoX');
            clearFieldError('demoK');
            clearFieldError('demoMessage');
            clearFieldError('demoFile');
        }

        // Add input listeners to clear errors on typing
        document.addEventListener('DOMContentLoaded', function () {
            ['demoP', 'demoQ', 'demoG', 'demoX', 'demoK', 'demoMessage'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', function () {
                        clearFieldError(id);
                    });
                }
            });
        });

        // Demo Algorithm Functions
        function loadSimpleParams() {
            // Danh s√°ch c√°c t·ªï h·ª£p tham s·ªë DSA h·ª£p l·ªá (ƒê√É KI·ªÇM TRA: g^q mod p = 1)
            const paramSets = [
                { p: 11, q: 5, g: 3, desc: 'p=11, q=5' },
                { p: 31, q: 5, g: 2, desc: 'p=31, q=5' },
                { p: 41, q: 5, g: 10, desc: 'p=41, q=5' },
                { p: 61, q: 5, g: 9, desc: 'p=61, q=5' },
                { p: 71, q: 5, g: 5, desc: 'p=71, q=5' },
                { p: 271, q: 5, g: 10, desc: 'p=271, q=5' },
                { p: 311, q: 5, g: 6, desc: 'p=311, q=5' },
                { p: 911, q: 5, g: 19, desc: 'p=911, q=5' },
                { p: 29, q: 7, g: 7, desc: 'p=29, q=7' },
                { p: 43, q: 7, g: 4, desc: 'p=43, q=7' },
                { p: 113, q: 7, g: 16, desc: 'p=113, q=7' },
                { p: 127, q: 7, g: 2, desc: 'p=127, q=7' },
                { p: 239, q: 7, g: 10, desc: 'p=239, q=7' },
                { p: 337, q: 7, g: 8, desc: 'p=337, q=7' },
                { p: 449, q: 7, g: 18, desc: 'p=449, q=7' },
                { p: 547, q: 7, g: 9, desc: 'p=547, q=7' },
                { p: 659, q: 7, g: 12, desc: 'p=659, q=7' },
                { p: 701, q: 7, g: 19, desc: 'p=701, q=7' },
                { p: 23, q: 11, g: 2, desc: 'p=23, q=11' },
                { p: 67, q: 11, g: 9, desc: 'p=67, q=11' },
                { p: 89, q: 11, g: 2, desc: 'p=89, q=11' },
                { p: 199, q: 11, g: 18, desc: 'p=199, q=11' },
                { p: 397, q: 11, g: 16, desc: 'p=397, q=11' },
                { p: 419, q: 11, g: 13, desc: 'p=419, q=11' },
                { p: 463, q: 11, g: 15, desc: 'p=463, q=11' },
                { p: 661, q: 11, g: 9, desc: 'p=661, q=11' },
                { p: 683, q: 11, g: 4, desc: 'p=683, q=11' },
                { p: 859, q: 11, g: 13, desc: 'p=859, q=11' },
                { p: 53, q: 13, g: 10, desc: 'p=53, q=13' },
                { p: 79, q: 13, g: 8, desc: 'p=79, q=13' },
                { p: 157, q: 13, g: 14, desc: 'p=157, q=13' },
                { p: 521, q: 13, g: 18, desc: 'p=521, q=13' },
                { p: 599, q: 13, g: 19, desc: 'p=599, q=13' },
                { p: 103, q: 17, g: 8, desc: 'p=103, q=17' },
                { p: 137, q: 17, g: 16, desc: 'p=137, q=17' },
                { p: 239, q: 17, g: 6, desc: 'p=239, q=17' },
                { p: 307, q: 17, g: 9, desc: 'p=307, q=17' },
                { p: 409, q: 17, g: 5, desc: 'p=409, q=17' },
                { p: 443, q: 17, g: 13, desc: 'p=443, q=17' },
                { p: 953, q: 17, g: 16, desc: 'p=953, q=17' }
            ];

            // Random ch·ªçn m·ªôt t·ªï h·ª£p
            const randomSet = paramSets[Math.floor(Math.random() * paramSets.length)];

            // Random x v√† k trong kho·∫£ng h·ª£p l·ªá
            const x = Math.floor(Math.random() * (randomSet.q - 2)) + 2; // 2 ƒë·∫øn q-1
            const k = Math.floor(Math.random() * (randomSet.q - 2)) + 2; // 2 ƒë·∫øn q-1

            document.getElementById('demoP').value = randomSet.p.toString();
            document.getElementById('demoQ').value = randomSet.q.toString();
            document.getElementById('demoG').value = randomSet.g.toString();
            document.getElementById('demoX').value = x.toString();
            document.getElementById('demoK').value = k.toString();

            showDemoAlert('sign', `ƒê√£ t·∫£i tham s·ªë: ${randomSet.desc}, g=${randomSet.g}, x=${x}, k=${k}`, 'success');
        }

        // Toggle between text and file input for signing
        function toggleDemoSignInput() {
            const type = document.querySelector('input[name="demoSignType"]:checked').value;
            const textInput = document.getElementById('demoTextInput');
            const fileInput = document.getElementById('demoFileInput');

            // X√≥a T·∫§T C·∫¢ n·ªôi dung v√† tham s·ªë
            document.getElementById('demoP').value = '';
            document.getElementById('demoQ').value = '';
            document.getElementById('demoG').value = '';
            document.getElementById('demoX').value = '';
            document.getElementById('demoK').value = '';
            document.getElementById('demoMessage').value = '';
            document.getElementById('demoFile').value = '';
            document.getElementById('demoFileName').textContent = 'Ch∆∞a ch·ªçn file';
            document.getElementById('demoFilePreview').style.display = 'none';
            
            // X√≥a k·∫øt qu·∫£ c≈©
            document.getElementById('demoResult').innerHTML = '';
            
            // X√≥a T·∫§T C·∫¢ c√°c l·ªói
            clearAllDemoErrors();

            if (type === 'text') {
                textInput.style.display = 'block';
                fileInput.style.display = 'none';
            } else {
                textInput.style.display = 'none';
                fileInput.style.display = 'block';
            }
        }

        // Toggle between text and file input for verification
        function toggleDemoVerifyInput() {
            const type = document.querySelector('input[name="demoVerifyType"]:checked').value;
            const textInput = document.getElementById('demoVerifyTextInput');
            const fileInput = document.getElementById('demoVerifyFileInput');

            // X√≥a T·∫§T C·∫¢ n·ªôi dung v√† tham s·ªë
            document.getElementById('verifyP').value = '';
            document.getElementById('verifyQ').value = '';
            document.getElementById('verifyG').value = '';
            document.getElementById('verifyY').value = '';
            document.getElementById('verifyR').value = '';
            document.getElementById('verifyS').value = '';
            document.getElementById('verifyMessage').value = '';
            document.getElementById('verifyFile').value = '';
            document.getElementById('verifyFileName').textContent = 'Ch∆∞a ch·ªçn file';
            document.getElementById('verifyFilePreview').style.display = 'none';
            
            // X√≥a k·∫øt qu·∫£ c≈©
            document.getElementById('demoVerifyResult').innerHTML = '';
            
            // X√≥a T·∫§T C·∫¢ c√°c l·ªói x√°c th·ª±c
            clearFieldError('verifyP');
            clearFieldError('verifyQ');
            clearFieldError('verifyG');
            clearFieldError('verifyY');
            clearFieldError('verifyR');
            clearFieldError('verifyS');
            clearFieldError('verifyMessage');
            clearFieldError('verifyFile');

            if (type === 'text') {
                textInput.style.display = 'block';
                fileInput.style.display = 'none';
            } else {
                textInput.style.display = 'none';
                fileInput.style.display = 'block';
            }
        }

        // Unified demo sign function (text or file)
        async function demoSign() {
            const type = document.querySelector('input[name="demoSignType"]:checked').value;
            if (type === 'text') {
                await demoSignMessage();
            } else {
                await demoSignFile();
            }
        }

        // Unified demo verify function (text or file)
        async function demoVerify() {
            const type = document.querySelector('input[name="demoVerifyType"]:checked').value;
            if (type === 'text') {
                await demoVerifyMessage();
            } else {
                await demoVerifyFile();
            }
        }

        async function demoSignMessage() {
            clearAllDemoErrors();

            const p = document.getElementById('demoP').value.trim();
            const q = document.getElementById('demoQ').value.trim();
            const g = document.getElementById('demoG').value.trim();
            const x = document.getElementById('demoX').value.trim();
            const k = document.getElementById('demoK').value.trim();
            const message = document.getElementById('demoMessage').value; // KH√îNG trim message!

            let hasError = false;

            // Validate t·ª´ng tr∆∞·ªùng
            if (!p) {
                showFieldError('demoP', 'Thi·∫øu tham s·ªë p. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!q) {
                showFieldError('demoQ', 'Thi·∫øu tham s·ªë q. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!g) {
                showFieldError('demoG', 'Thi·∫øu tham s·ªë g. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!x) {
                showFieldError('demoX', 'Thi·∫øu private key x. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!message) {
                showFieldError('demoMessage', 'Thi·∫øu vƒÉn b·∫£n. Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn k√Ω.');
                hasError = true;
            }

            if (hasError) {
                return;
            }

            showLoading('demoLoading', true);

            try {
                const response = await fetch('/api/demo-sign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p, q, g, x, k, message })
                });
                const data = await response.json();

                showLoading('demoLoading', false);

                if (data.success) {
                    showDemoAlert('sign', data.message, 'success');
                    displayDemoResult(data.result, message, 'text');
                } else {
                    // X√≥a k·∫øt qu·∫£ c≈© khi c√≥ l·ªói
                    document.getElementById('demoResult').innerHTML = '';
                    
                    // X·ª≠ l√Ω l·ªói theo field c·ª• th·ªÉ
                    const errorMsg = data.error;
                    const field = data.field;

                    if (field) {
                        showFieldError('demo' + field.charAt(0).toUpperCase() + field.slice(1), errorMsg);
                    } else {
                        showDemoAlert('sign', errorMsg, 'error');
                    }
                }
            } catch (error) {
                showLoading('demoLoading', false);
                showDemoAlert('sign', 'L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        async function demoSignFile() {
            clearAllDemoErrors();

            const p = document.getElementById('demoP').value.trim();
            const q = document.getElementById('demoQ').value.trim();
            const g = document.getElementById('demoG').value.trim();
            const x = document.getElementById('demoX').value.trim();
            const k = document.getElementById('demoK').value.trim();
            const fileInput = document.getElementById('demoFile');

            let hasError = false;

            // Validate t·ª´ng tr∆∞·ªùng
            if (!p) {
                showFieldError('demoP', 'Thi·∫øu tham s·ªë p. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!q) {
                showFieldError('demoQ', 'Thi·∫øu tham s·ªë q. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!g) {
                showFieldError('demoG', 'Thi·∫øu tham s·ªë g. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }
            if (!x) {
                showFieldError('demoX', 'Thi·∫øu private key x. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.');
                hasError = true;
            }

            if (!fileInput.files.length) {
                showFieldError('demoFile', 'Ch∆∞a ch·ªçn file. Vui l√≤ng ch·ªçn file c·∫ßn k√Ω.');
                hasError = true;
            } else {
                // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 5MB cho demo)
                const maxSize = 5 * 1024 * 1024;
                if (fileInput.files[0].size > maxSize) {
                    showFieldError('demoFile', 'File qu√° l·ªõn! Gi·ªõi h·∫°n 5MB cho demo.');
                    hasError = true;
                }
            }

            if (hasError) {
                return;
            }

            showLoading('demoLoading', true);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('p', p);
            formData.append('q', q);
            formData.append('g', g);
            formData.append('x', x);
            if (k) formData.append('k', k);

            try {
                const response = await fetch('/api/demo-sign-file', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                showLoading('demoLoading', false);

                if (data.success) {
                    showDemoAlert('sign', data.message, 'success');
                    displayDemoResult(data.result, data.file_content, 'file', data.filename);
                } else {
                    // X√≥a k·∫øt qu·∫£ c≈© khi c√≥ l·ªói
                    document.getElementById('demoResult').innerHTML = '';
                    
                    // X·ª≠ l√Ω l·ªói theo field c·ª• th·ªÉ
                    const errorMsg = data.error;
                    const field = data.field;

                    if (field) {
                        if (field === 'file') {
                            showFieldError('demoFile', errorMsg);
                        } else {
                            showFieldError('demo' + field.charAt(0).toUpperCase() + field.slice(1), errorMsg);
                        }
                    } else {
                        showDemoAlert('sign', errorMsg, 'error');
                    }
                }
            } catch (error) {
                showLoading('demoLoading', false);
                showDemoAlert('sign', 'L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        function displayDemoResult(result, content, type, filename = '') {
            const resultDiv = document.getElementById('demoResult');

            const contentPreview = content.length > 50 ? content.substring(0, 50) + '...' : content;
            const typeLabel = type === 'file' ? `File: ${filename}` : 'VƒÉn b·∫£n';

            const r = result;
            
            // L∆∞u k·∫øt qu·∫£ k√Ω ƒë·ªÉ so s√°nh khi x√°c th·ª±c (cho c·∫£ text v√† file)
            lastDemoSignResult = {
                p: r.params.p,
                q: r.params.q,
                g: r.params.g,
                y: r.step1.y,
                r: r.signature.r,
                s: r.signature.s,
                message: content, // L∆∞u to√†n b·ªô n·ªôi dung (text ho·∫∑c file content)
                type: type,
                filename: filename
            };
            
            // T·ª∞ ƒê·ªòNG ƒêI·ªÄN C√ÅC GI√Å TR·ªä V√ÄO PH·∫¶N X√ÅC TH·ª∞C
            document.getElementById('verifyP').value = r.params.p;
            document.getElementById('verifyQ').value = r.params.q;
            document.getElementById('verifyG').value = r.params.g;
            document.getElementById('verifyY').value = r.step1.y;
            document.getElementById('verifyR').value = r.signature.r;
            document.getElementById('verifyS').value = r.signature.s;
            
            // N·∫øu l√† text, ƒëi·ªÅn v√†o textarea; n·∫øu l√† file, kh√¥ng ƒëi·ªÅn (c·∫ßn upload file)
            if (type === 'text') {
                document.getElementById('verifyMessage').value = content;
                // Hi·ªÉn th·ªã th√¥ng b√°o ƒë√£ t·ª± ƒë·ªông ƒëi·ªÅn
                showDemoAlert('verify', '‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn c√°c gi√° tr·ªã v√†o ph·∫ßn X√°c th·ª±c. B·∫°n c√≥ th·ªÉ nh·∫•n "X√°c th·ª±c" ngay!', 'success');
            } else {
                // V·ªõi file, c·∫ßn upload l·∫°i file
                showDemoAlert('verify', '‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn c√°c tham s·ªë. Vui l√≤ng upload l·∫°i file g·ªëc ƒë·ªÉ x√°c th·ª±c.', 'success');
            }

            resultDiv.innerHTML = `
                <div class="result-box" style="border: 3px solid #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                    <h4 style="color: #28a745; margin-bottom: 20px; font-size: 22px;">K·∫øt qu·∫£ K√Ω (SIGNING)</h4>
                    
                    <!-- Tham s·ªë ƒë·∫ßu v√†o -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 8px; padding: 18px; margin-bottom: 15px;">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 20px; font-weight: 600;">Tham s·ªë ƒë·∫ßu v√†o:</h5>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; font-size: 17px;">
                            <div><strong>p:</strong> ${r.params.p}</div>
                            <div><strong>q:</strong> ${r.params.q}</div>
                            <div><strong>g:</strong> ${r.params.g}</div>
                            <div><strong>x:</strong> ${r.params.x}</div>
                            <div><strong>k:</strong> ${r.params.k}</div>
                        </div>
                        <div style="margin-top: 12px; font-size: 17px;"><strong>Message:</strong> "${contentPreview}"</div>
                    </div>

                    <!-- B∆Ø·ªöC K√ù -->
                    <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #ffc107; border-radius: 8px; padding: 18px; margin-bottom: 15px;">
                        <h5 style="color: #856404; margin-bottom: 15px; font-size: 20px; font-weight: 600;">B∆Ø·ªöC K√ù (SIGNING)</h5>
                        
                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #856404; font-size: 17px;">B∆∞·ªõc 1: T√≠nh Public Key (y)</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 16px; color: #333; line-height: 1.6;">
                                ${r.step1.formula}
                            </div>
                            <div style="margin-top: 8px; color: #28a745; font-weight: 600; font-size: 17px;">‚Üí y = ${r.step1.y}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #856404; font-size: 17px;">B∆∞·ªõc 2: Hash Message</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 16px; color: #333; line-height: 1.6;">
                                ${r.step2.formula}
                            </div>
                            <div style="margin-top: 8px; color: #28a745; font-weight: 600; font-size: 17px;">‚Üí H(m) = ${r.step2.hash}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #856404; font-size: 17px;">B∆∞·ªõc 3: T√≠nh r</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 15px; color: #333; line-height: 1.6;">
                                ${r.step3.formula}
                            </div>
                            <div style="margin-top: 8px; color: #28a745; font-weight: 600; font-size: 17px;">‚Üí r = ${r.step3.r}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px;">
                            <strong style="color: #856404; font-size: 17px;">B∆∞·ªõc 4: T√≠nh s</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 15px; color: #333; line-height: 1.6;">
                                k‚Åª¬π = ${r.step4.k_inv}<br>
                                x √ó r = ${r.params.x} √ó ${r.step3.r} = ${r.step4.x_r}<br>
                                H(m) + x√ór = ${r.step2.hash} + ${r.step4.x_r} = ${r.step4.h_plus_xr}<br>
                                ${r.step4.formula}
                            </div>
                            <div style="margin-top: 8px; color: #28a745; font-weight: 600; font-size: 17px;">‚Üí s = ${r.step4.s}</div>
                        </div>
                    </div>

                    <!-- CH·ªÆ K√ù -->
                    <div style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: 3px solid #17a2b8; border-radius: 8px; padding: 18px;">
                        <h5 style="color: #0c5460; margin-bottom: 12px; font-size: 22px; font-weight: 600;">CH·ªÆ K√ù S·ªê DSA</h5>
                        <div style="font-size: 19px; font-weight: 600; color: #0c5460;">
                            Signature = (r, s) = (${r.signature.r}, ${r.signature.s})
                        </div>
                    </div>
                </div>
            `;
        }

        // Demo Verify Message
        async function demoVerifyMessage() {
            // Clear errors for all verify fields
            ['verifyP', 'verifyQ', 'verifyG', 'verifyY', 'verifyR', 'verifyS', 'verifyMessage'].forEach(id => {
                clearFieldError(id);
            });

            const p = document.getElementById('verifyP').value.trim();
            const q = document.getElementById('verifyQ').value.trim();
            const g = document.getElementById('verifyG').value.trim();
            const y = document.getElementById('verifyY').value.trim();
            const r = document.getElementById('verifyR').value.trim();
            const s = document.getElementById('verifyS').value.trim();
            const message = document.getElementById('verifyMessage').value; // KH√îNG trim message!

            let hasError = false;

            // Validate t·ª´ng tr∆∞·ªùng v·ªõi th√¥ng b√°o c·ª• th·ªÉ
            if (!p) {
                showFieldError('verifyP', 'Thi·∫øu tham s·ªë p. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!q) {
                showFieldError('verifyQ', 'Thi·∫øu tham s·ªë q. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!g) {
                showFieldError('verifyG', 'Thi·∫øu tham s·ªë g. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!y) {
                showFieldError('verifyY', 'Thi·∫øu public key y. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!r) {
                showFieldError('verifyR', 'Thi·∫øu ch·ªØ k√Ω r. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!s) {
                showFieldError('verifyS', 'Thi·∫øu ch·ªØ k√Ω s. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!message) {
                showFieldError('verifyMessage', 'Thi·∫øu vƒÉn b·∫£n. Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn x√°c th·ª±c.');
                hasError = true;
            }

            if (hasError) {
                return;
            }

            showLoading('demoVerifyLoading', true);

            if (lastDemoSignResult) {
                // C·∫£nh b√°o n·∫øu message kh√°c
                if (message !== lastDemoSignResult.message) {
                    const confirmContinue = confirm(
                        '‚ö†Ô∏è C·∫¢NH B√ÅO: Message kh√°c v·ªõi message g·ªëc!\n\n' +
                        `Message g·ªëc: "${lastDemoSignResult.message}" (${lastDemoSignResult.message.length} k√Ω t·ª±)\n` +
                        `Message hi·ªán t·∫°i: "${message}" (${message.length} k√Ω t·ª±)\n\n` +
                        'X√°c th·ª±c s·∫Ω TH·∫§T B·∫†I. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?'
                    );
                    if (!confirmContinue) {
                        showLoading('demoVerifyLoading', false);
                        return;
                    }
                }
            }

            try {
                // Chu·∫©n b·ªã payload v·ªõi th√¥ng tin g·ªëc n·∫øu c√≥
                const payload = { p, q, g, y, r, s, message };

                // G·ª≠i th√¥ng tin g·ªëc t·ª´ k·∫øt qu·∫£ k√Ω ƒë·ªÉ so s√°nh ch√≠nh x√°c
                if (lastDemoSignResult) {
                    payload.original_p = lastDemoSignResult.p;
                    payload.original_q = lastDemoSignResult.q;
                    payload.original_g = lastDemoSignResult.g;
                    payload.original_y = lastDemoSignResult.y;
                    payload.original_r = lastDemoSignResult.r;
                    payload.original_s = lastDemoSignResult.s;
                    payload.original_message = lastDemoSignResult.message;
                }

                const response = await fetch('/api/demo-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                showLoading('demoVerifyLoading', false);

                if (data.success) {
                    displayDemoVerifyResult(data.result, message);
                } else {
                    // Parse error message to show on specific fields
                    const errorMsg = data.error;

                    if (errorMsg.includes('Thi·∫øu tham s·ªë:')) {
                        const match = errorMsg.match(/Thi·∫øu tham s·ªë: (.+?)\./);
                        if (match) {
                            const missing = match[1].split(', ');
                            missing.forEach(param => {
                                if (param === 'p') showFieldError('verifyP', 'Thi·∫øu tham s·ªë p');
                                if (param === 'q') showFieldError('verifyQ', 'Thi·∫øu tham s·ªë q');
                                if (param === 'g') showFieldError('verifyG', 'Thi·∫øu tham s·ªë g');
                            });
                        }
                    } else if (errorMsg.includes('Public key y')) {
                        showFieldError('verifyY', errorMsg);
                    } else if (errorMsg.includes('Ch·ªØ k√Ω r')) {
                        showFieldError('verifyR', errorMsg);
                    } else if (errorMsg.includes('Ch·ªØ k√Ω s')) {
                        showFieldError('verifyS', errorMsg);
                    } else if (errorMsg.includes('parse')) {
                        // L·ªói parse - c√≥ th·ªÉ do nh·∫≠p sai format
                        showDemoAlert('verify', errorMsg + ' Vui l√≤ng ki·ªÉm tra l·∫°i c√°c gi√° tr·ªã ƒë√£ nh·∫≠p.', 'error');
                    } else {
                        showDemoAlert('verify', errorMsg, 'error');
                    }
                }
            } catch (error) {
                showLoading('demoVerifyLoading', false);
                showDemoAlert('verify', 'L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        // Demo Verify File
        async function demoVerifyFile() {
            // Clear errors for all verify fields
            ['verifyP', 'verifyQ', 'verifyG', 'verifyY', 'verifyR', 'verifyS', 'verifyFile'].forEach(id => {
                clearFieldError(id);
            });

            const p = document.getElementById('verifyP').value.trim();
            const q = document.getElementById('verifyQ').value.trim();
            const g = document.getElementById('verifyG').value.trim();
            const y = document.getElementById('verifyY').value.trim();
            const r = document.getElementById('verifyR').value.trim();
            const s = document.getElementById('verifyS').value.trim();
            const fileInput = document.getElementById('verifyFile');

            let hasError = false;

            // Validate t·ª´ng tr∆∞·ªùng v·ªõi th√¥ng b√°o c·ª• th·ªÉ
            if (!p) {
                showFieldError('verifyP', 'Thi·∫øu tham s·ªë p. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!q) {
                showFieldError('verifyQ', 'Thi·∫øu tham s·ªë q. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!g) {
                showFieldError('verifyG', 'Thi·∫øu tham s·ªë g. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!y) {
                showFieldError('verifyY', 'Thi·∫øu public key y. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!r) {
                showFieldError('verifyR', 'Thi·∫øu ch·ªØ k√Ω r. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!s) {
                showFieldError('verifyS', 'Thi·∫øu ch·ªØ k√Ω s. Vui l√≤ng sao ch√©p t·ª´ k·∫øt qu·∫£ k√Ω.');
                hasError = true;
            }
            if (!fileInput.files.length) {
                showFieldError('verifyFile', 'Ch∆∞a ch·ªçn file. Vui l√≤ng ch·ªçn file c·∫ßn x√°c th·ª±c.');
                hasError = true;
            } else {
                // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 5MB cho demo)
                const maxSize = 5 * 1024 * 1024;
                if (fileInput.files[0].size > maxSize) {
                    showDemoAlert('verify', 'File qu√° l·ªõn! Gi·ªõi h·∫°n 5MB cho demo.', 'error');
                    hasError = true;
                }
            }

            if (hasError) {
                return;
            }

            showLoading('demoVerifyLoading', true);

            // G·ª≠i file l√™n server ƒë·ªÉ x·ª≠ l√Ω (kh√¥ng ƒë·ªçc ·ªü client)
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('p', p);
            formData.append('q', q);
            formData.append('g', g);
            formData.append('y', y);
            formData.append('r', r);
            formData.append('s', s);
            
            // G·ª≠i th√¥ng tin g·ªëc n·∫øu c√≥
            if (lastDemoSignResult) {
                formData.append('original_p', lastDemoSignResult.p);
                formData.append('original_q', lastDemoSignResult.q);
                formData.append('original_g', lastDemoSignResult.g);
                formData.append('original_y', lastDemoSignResult.y);
                formData.append('original_r', lastDemoSignResult.r);
                formData.append('original_s', lastDemoSignResult.s);
                if (lastDemoSignResult.type === 'file') {
                    formData.append('original_filename', lastDemoSignResult.filename);
                }
            }

            try {
                const response = await fetch('/api/demo-verify-file', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                showLoading('demoVerifyLoading', false);

                if (data.success) {
                    // V·ªõi file, kh√¥ng c·∫ßn truy·ªÅn message v√¨ ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü server
                    displayDemoVerifyResult(data.result, `[File: ${file.name}]`);
                } else {
                    // Parse error message to show on specific fields
                    const errorMsg = data.error;

                    if (errorMsg.includes('Thi·∫øu tham s·ªë')) {
                        showDemoAlert('verify', errorMsg, 'error');
                    } else if (errorMsg.includes('Public key y')) {
                        showFieldError('verifyY', errorMsg);
                    } else if (errorMsg.includes('Ch·ªØ k√Ω r')) {
                        showFieldError('verifyR', errorMsg);
                    } else if (errorMsg.includes('Ch·ªØ k√Ω s')) {
                        showFieldError('verifyS', errorMsg);
                    } else if (errorMsg.includes('parse')) {
                        showDemoAlert('verify', errorMsg + ' Vui l√≤ng ki·ªÉm tra l·∫°i c√°c gi√° tr·ªã ƒë√£ nh·∫≠p.', 'error');
                    } else {
                        showDemoAlert('verify', errorMsg, 'error');
                    }
                }
            } catch (error) {
                showLoading('demoVerifyLoading', false);
                showDemoAlert('verify', 'L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        function displayDemoVerifyResult(result, message) {
            const resultDiv = document.getElementById('demoVerifyResult');
            const r = result;

            const contentPreview = message.length > 50 ? message.substring(0, 50) + '...' : message;

            resultDiv.innerHTML = `
                <div class="result-box" style="border: 3px solid ${r.is_valid ? '#28a745' : '#dc3545'}; background: linear-gradient(135deg, ${r.is_valid ? '#d4edda' : '#f8d7da'} 0%, ${r.is_valid ? '#c3e6cb' : '#f5c6cb'} 100%);">
                    <h4 style="color: ${r.is_valid ? '#28a745' : '#dc3545'}; margin-bottom: 20px; font-size: 22px;">K·∫øt qu·∫£ X√°c th·ª±c (VERIFICATION)</h4>
                    
                    <!-- Tham s·ªë ƒë·∫ßu v√†o -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 8px; padding: 18px; margin-bottom: 15px;">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 20px; font-weight: 600;">Tham s·ªë ƒë·∫ßu v√†o:</h5>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; font-size: 17px;">
                            <div><strong>p:</strong> ${r.params.p}</div>
                            <div><strong>q:</strong> ${r.params.q}</div>
                            <div><strong>g:</strong> ${r.params.g}</div>
                            <div><strong>y:</strong> ${r.params.y}</div>
                            <div><strong>r:</strong> ${r.signature.r}</div>
                        </div>
                        <div style="margin-top: 8px; font-size: 17px;"><strong>s:</strong> ${r.signature.s}</div>
                        <div style="margin-top: 12px; font-size: 17px;"><strong>Message:</strong> "${contentPreview}"</div>
                        ${lastDemoSignResult && lastDemoSignResult.message && !message.startsWith('[File:') ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px;">
                                <strong style="color: #1976d2;">üîç Debug Info:</strong><br>
                                <span style="font-family: monospace;">Message g·ªëc (khi k√Ω): "${lastDemoSignResult.message.substring(0, 50)}${lastDemoSignResult.message.length > 50 ? '...' : ''}" (${lastDemoSignResult.message.length} k√Ω t·ª±)</span><br>
                                <span style="font-family: monospace;">Message hi·ªán t·∫°i: "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}" (${message.length} k√Ω t·ª±)</span><br>
                                <span style="color: ${message === lastDemoSignResult.message ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                    ${message === lastDemoSignResult.message ? '‚úì Message kh·ªõp ch√≠nh x√°c' : '‚úó Message KH√ÅC NHAU - ƒê√¢y l√† nguy√™n nh√¢n x√°c th·ª±c th·∫•t b·∫°i!'}
                                </span>
                            </div>
                        ` : ''}
                        ${message.startsWith('[File:') ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px;">
                                <strong style="color: #1976d2;">‚ÑπÔ∏è L∆∞u √Ω:</strong><br>
                                <span style="font-size: 13px;">V·ªõi file, n·ªôi dung ƒë∆∞·ª£c ƒë·ªçc v√† hash tr·ª±c ti·∫øp t·ª´ file b·∫°n upload.</span><br>
                                <span style="font-size: 13px;">ƒê·∫£m b·∫£o upload ƒë√∫ng file g·ªëc ƒë·ªÉ x√°c th·ª±c th√†nh c√¥ng.</span>
                            </div>
                        ` : ''}
                    </div>

                    <!-- B∆Ø·ªöC X√ÅC TH·ª∞C -->
                    <div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; border-radius: 8px; padding: 18px; margin-bottom: 15px;">
                        <h5 style="color: #721c24; margin-bottom: 15px; font-size: 20px; font-weight: 600;">B∆Ø·ªöC X√ÅC TH·ª∞C (VERIFICATION)</h5>
                        
                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #721c24; font-size: 17px;">B∆∞·ªõc 1: Hash Message</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 16px; color: #333; line-height: 1.6;">
                                ${r.step1.formula}
                            </div>
                            <div style="margin-top: 8px; color: #dc3545; font-weight: 600; font-size: 17px;">‚Üí H(m) = ${r.step1.hash}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #721c24; font-size: 17px;">B∆∞·ªõc 2: T√≠nh w</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 16px; color: #333; line-height: 1.6;">
                                ${r.step2.formula}
                            </div>
                            <div style="margin-top: 8px; color: #dc3545; font-weight: 600; font-size: 17px;">‚Üí w = ${r.step2.w}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #721c24; font-size: 17px;">B∆∞·ªõc 3: T√≠nh u1</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 16px; color: #333; line-height: 1.6;">
                                ${r.step3.formula}
                            </div>
                            <div style="margin-top: 8px; color: #dc3545; font-weight: 600; font-size: 17px;">‚Üí u1 = ${r.step3.u1}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px; margin-bottom: 12px;">
                            <strong style="color: #721c24; font-size: 17px;">B∆∞·ªõc 4: T√≠nh u2</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 16px; color: #333; line-height: 1.6;">
                                ${r.step4.formula}
                            </div>
                            <div style="margin-top: 8px; color: #dc3545; font-weight: 600; font-size: 17px;">‚Üí u2 = ${r.step4.u2}</div>
                        </div>

                        <div style="background: white; border-radius: 6px; padding: 14px;">
                            <strong style="color: #721c24; font-size: 17px;">B∆∞·ªõc 5: T√≠nh v</strong>
                            <div style="margin-top: 10px; font-family: monospace; font-size: 15px; color: #333; line-height: 1.6;">
                                g^u1 mod p = ${r.params.g}^${r.step3.u1} mod ${r.params.p} = ${r.step5.g_u1}<br>
                                y^u2 mod p = ${r.params.y}^${r.step4.u2} mod ${r.params.p} = ${r.step5.y_u2}<br>
                                (g^u1 √ó y^u2) mod p = (${r.step5.g_u1} √ó ${r.step5.y_u2}) mod ${r.params.p} = ${r.step5.g_u1_y_u2}<br>
                                v = ${r.step5.g_u1_y_u2} mod ${r.params.q} = ${r.step5.v}
                            </div>
                            <div style="margin-top: 8px; color: #dc3545; font-weight: 600; font-size: 17px;">‚Üí v = ${r.step5.v}</div>
                        </div>
                    </div>

                    <!-- K·∫æT QU·∫¢ -->
                    <div style="background: ${r.is_valid ? '#d4edda' : '#f8d7da'}; border: 3px solid ${r.is_valid ? '#28a745' : '#dc3545'}; border-radius: 8px; padding: 18px;">
                        <h5 style="color: ${r.is_valid ? '#155724' : '#721c24'}; margin-bottom: 12px; font-size: 20px; font-weight: 600;">B∆∞·ªõc 6: Ki·ªÉm tra v == r</h5>
                        <div style="font-family: monospace; font-size: 17px; color: #333; line-height: 1.6;">
                            v = ${r.step5.v}<br>
                            r = ${r.signature.r}<br>
                            ${r.step5.v} ${r.is_valid ? '==' : '!='} ${r.signature.r}
                        </div>
                        <div style="margin-top: 15px; font-size: 22px; font-weight: 700; color: ${r.is_valid ? '#28a745' : '#dc3545'};">
                            ${r.is_valid ? 'CH·ªÆ K√ù H·ª¢P L·ªÜ' : 'CH·ªÆ K√ù KH√îNG H·ª¢P L·ªÜ'}
                        </div>
                        <p style="margin-top: 10px; font-size: 17px; color: ${r.is_valid ? '#155724' : '#721c24'}; line-height: 1.5;">
                            ${r.is_valid ? 'VƒÉn b·∫£n ch∆∞a b·ªã thay ƒë·ªïi v√† ch·ªØ k√Ω h·ª£p l·ªá.' : '‚ùå X√ÅC TH·ª∞C TH·∫§T B·∫†I - v ‚â† r<br>VƒÉn b·∫£n ƒë√£ b·ªã thay ƒë·ªïi'}
                        </p>
                    </div>
                </div>
            `;
        }

        // Load key status on page load
        updateKeyStatus();
    </script>
</body>

</html>